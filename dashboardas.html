<!DOCTYPE html>
<html lang="en">
<head>
<!-- Basic Meta Tags -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Miela Malonu Dashboardas">
<meta name="keywords" content="miela malonu, dashboardas, gauja, statusai, ispėjimai">
<meta name="author" content="Miela Malonu">

<!-- Favicon and App Icons -->
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#0f0f0f">
<meta name="msapplication-TileColor" content="#0f0f0f">
<meta name="theme-color" content="#0f0f0f">



<!-- Preconnect to External Resources -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://discord.com" crossorigin>

<!-- Preload Critical Assets -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" as="style">
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" as="script">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="icon" type="image/gif" href="https://i.imgur.com/amma0ov.gif">
    <title>Dashboardas - Miela Malonu</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="styles/dashboardas.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <img src="https://cdn.discordapp.com/icons/1325850250027597845/a_390be3fdaab65e28c28d150ca21d93bb.gif?size=1024" alt="Gang Logo" class="logo-img">
                <span>Miela Malonu</span>
            </div>
            <div class="user-profile">
                <img src="/api/placeholder/40/40" alt="User Avatar" class="user-avatar" id="userAvatar">
                <span class="user-name" id="userName">Neprisijungta</span>
                <span class="logout-btn" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </span>
            </div>
        </header>

        <div class="navigation">
            <button class="nav-button active" data-tab="dashboard">Dashboardas</button>
            <button class="nav-button" data-tab="warnings">Ispėjimai</button>
            <button class="nav-button" data-tab="icinfo">IC Info</button>
           
<button class="nav-button" data-tab="rules">Taisyklės</button>
<button class="nav-button" data-tab="info">Gaujos Info</button>
        </div>

        <div class="content-container">
            <!-- Login screen (shown when not authenticated) -->
            <div class="welcome-section" id="loginScreen">
                <h2>Sveikas, Prisijunges I Miela Malonu</h2>
                <p>Prašome prisijungti su Discord</p>
                <button class="login-btn" id="loginButton">
                    <i class="fab fa-discord"></i> Prisijungti
                </button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboard">
                <h2>Dashboardas</h2>

                <div class="stat-cards">
                    <div class="stat-card">
                        <div class="stat-label">Ispėjimai</div>
                        <div class="stat-value" id="warningCount">-</div>
                        <span class="status-badge" id="warningStatus">-</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">IC Statusas
                        </div>
                        <div class="stat-value"><i id="icStatusIcon" class="fas fa-circle" style="color: #3ba55c; font-size: 24px;"></i></div>
                        <span class="status-badge" id="icStatusBadge">-</span>
                    </div>
</div>
</div>
            <!-- Warnings Tab -->
            <div class="tab-content" id="warnings">
                <h2>Tavo Ispėjimai</h2>
                <div class="info-section">
                    <h3>Ispėjimai</h3>
                    <div id="warningsContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
<!-- Info Tab -->
<div class="tab-content" id="info">
    <h2>Informacija Apie Gaują</h2>
    
    <div class="info-section">
        <h3>Apranga</h3>
        <div class="info-item">
            <div class="info-label">Liemenė</div>
            <div class="vest-color-value">156</div>
        </div>
    </div>
    
    <div class="info-section">
        <h3>Bindai (spustelėkite, kad nukopijuoti)</h3>
        <div class="info-item">
            <div class="bind-box" onclick="copyToClipboard('bind keyboard 0 &quot;s ~ws~ ~b~ ~l~STOJI ~w~/ ~l~PAKELI ~w~RANKAS ~l~ARBA ~w~SAUDYSIM ~ws&quot;')">
                bind keyboard 0 "s ~ws~ ~b~ ~l~STOJI ~w~/ ~l~PAKELI ~w~RANKAS ~l~ARBA ~w~SAUDYSIM ~ws"
                <div class="copy-message">Nukopijuota!</div>
                <span class="copy-icon">📋</span>
            </div>
            <div class="bind-box" onclick="copyToClipboard('bind keyboard 9 &quot;s ~ws ~l~MIELA MALONU ~ws~&quot;')">
                bind keyboard 9 "s ~ws ~l~MIELA MALONU ~ws~"
                <div class="copy-message">Nukopijuota!</div>
                <span class="copy-icon">📋</span>
            </div>
        </div>
    </div>
    
    <div class="info-section">
        <h3>Discord Serveris</h3>
        <div class="info-item">
            <div class="discord-invite-container">
                <div class="discord-server-info">
                    <img src="https://cdn.discordapp.com/icons/1325850250027597845/a_390be3fdaab65e28c28d150ca21d93bb.gif?size=1024" alt="Server Icon" class="discord-server-icon">
                    <div>
                        <div class="discord-server-name">Miela Malonu</div>
                        <div class="server-members">
                            <span class="online-indicator"></span>
                            <span>52 Online</span>
                            <span style="margin: 0 4px;">•</span>
                            <span>249 Members</span>
                        </div>
                    </div>
                </div>
                <a href="https://discord.gg/VfC3Ay86cW" target="_blank" class="join-discord-btn">
                    <svg width="20" height="15" viewBox="0 0 71 55" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="#ffffff"/>
                    </svg>
                    Prisijungti
                </a>
            </div>
        </div>
    </div>
</div>
<!-- Rules Tab -->
<div class="tab-content" id="rules">
    <h2>Gaujos Taisyklės</h2>
    
    <div class="rule-section">
        <h3>Bendrosios taisyklės</h3>
        <div class="rule">1.1 Kiekvienas gaujos narys privalo laikytis vadovybės nurodymų ir gaujos nustatytų taisyklių.</div>
        <div class="rule">1.2 Gaujos nariai privalo būti aktyvūs ir dalyvauti gaujos veikloje.</div>
        <div class="rule">1.3 Griežtai draudžiama bendradarbiauti su kitomis gaujomis.</div>
        <div class="rule">1.4 Draudžiama naudoti bet kokias programas ar metodus, suteikiančius nesąžiningą pranašumą (cheat'ai, exploit'ai).</div>
    </div>
    
    <div class="rule-section">
        <h3>PVP taisyklės</h3>
        <div class="rule">2.1 Prieš pradedant kovą su kita gauja, būtina suderinti veiksmus su gaujos vadu ar pavaduotoju arba kapitonu</div>
        <div class="rule">2.2 Draudžiama šaudyti į sąjungininkus ar neutralius žaidėjus be priežasties.</div>
        <div class="rule">2.3 Racijoj. bei Discorde komomunikuoti suprantamai ir tik reikalinga info.</div>
        <div class="rule">2.4 Kiekvienas gaujos narys privalo dalyvauti organizuotose kovose, nebent turi pagrįstą priežastį nedalyvauti.</div>
        <div class="rule">2.5 Komunikuojant draudžiama bet kokia nepagarba saviems</div>
    </div>
    
    <div class="rule-section">
        <h3>Nuobaudos</h3>
        <div class="rule">3.1 Už taisyklių pažeidimą narys gali būti įspėtas arba pašalintas iš gaujos.</div>
        <div class="rule">3.2 Už tyčini sabotažą (Trolinama ar kitoki trugdymą) taikomos griežtos sankcijos, įskaitant pašalinimą iš gaujos be įspėjimo.</div>
    </div>
    
    <div class="rule-section">
        <h3>Discord taisyklės</h3>
        <div class="rule">4.1 Draudžiama kitų discord serverių reklama, nebent turite vadovybės leidimą (Kitų FiveM serverių, gaujų discordų, discord shopu ir pnš. reklama)</div>
        <div class="rule">4.2 Draudžiama leak'inti bet kokio savo informacija (OOC Vardas, Pavardė, IP, Veidas ir t.t.)</div>
        <div class="rule">4.3 Draudžiama dezinformacija</div>
        <div class="rule">4.4 Draudžiama bet kokia nepagarba discord chatuose</div>
        <div class="rule">4.5 Būtina užsipildyti IC INFO kitaip bus nuimtas jobas IC</div>
    </div>
</div>
            <!-- IC Info Tab -->
            <div class="tab-content" id="icinfo">
                <h2>IC Informacija</h2>
                <div class="info-section">
                    <h3>Statusas</h3>
                    <div id="icStatusContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
                <div class="info-section">
                    <h3>Gango Informacija</h3>
                    <div id="gangDetailsContainer">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
 <a href="https://mielamalonu.com/ids" class="links-item" target="_blank">
            <i class="fas fa-map-marked-alt"></i>
            <div class="links-name">IDS</div>
            <i class="fas fa-external-link-alt"></i>
        </a>
            </div>

            
               

        <footer>
            Miela Malonu Dashboardas &copy; 2025
        </footer>
    </div>


    <script>
// ===== SIMPLIFIED DISCORD AUTH INTEGRATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Discord OAuth configuration
    const DISCORD_CLIENT_ID = '1263389179249692693';
    const REDIRECT_URI = encodeURIComponent(window.location.origin + window.location.pathname);
    const DISCORD_AUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=identify`;
    
    // Supabase configuration (just for data access, not auth)
    const SUPABASE_URL = 'https://smodsdsnswwtnbnmzhse.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtb2RzZHNuc3d3dG5ibm16aHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE2MjUyOTAsImV4cCI6MjA1NzIwMTI5MH0.zMdjymIaGU66_y6X-fS8nKnrWgJjXgw7NgXPBIzVCiI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // DOM Elements
    const tabButtons = document.querySelectorAll('.nav-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const loginScreen = document.getElementById('loginScreen');
    const loginButton = document.getElementById('loginButton');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
    
    // Event listeners
    tabButtons.forEach(button => {
        button.addEventListener('click', () => switchTab(button));
    });
    
    loginButton.addEventListener('click', initiateDiscordLogin);
    if (logoutBtn) {
        logoutBtn.addEventListener('click', logoutUser);
    }
    
    // Check login status on page load
    checkAuthStatus();
    
    // ===== AUTHENTICATION FUNCTIONS =====
    
    function initiateDiscordLogin() {
        // Redirect to Discord OAuth
        window.location.href = DISCORD_AUTH_URL;
    }
    
    function checkAuthStatus() {
        // First check if we have a hash in the URL (returning from Discord OAuth)
        if (window.location.hash.includes('access_token=')) {
            handleDiscordAuthResponse();
            return;
        }
        
        // Check localStorage for saved Discord info
        const savedDiscordId = localStorage.getItem('discord_id');
        const savedDiscordUsername = localStorage.getItem('discord_username');
        const savedDiscordAvatar = localStorage.getItem('discord_avatar');
        
        if (savedDiscordId) {
            // User has previously authenticated
            updateUserUI(savedDiscordUsername, savedDiscordAvatar);
            hideLoginScreen();
            loadDashboardData(savedDiscordId);
            logoutBtn.style.display = 'inline-block';
        } else {
            // Show login screen
            showLoginScreen();
            logoutBtn.style.display = 'none';
        }
    }
    // Add Gang Equipment Information
const gangEquipmentSection = document.createElement('div');
gangEquipmentSection.className = 'info-section mt-4';
gangEquipmentSection.innerHTML = `
    <h3>Apranga</h3>
    <div class="icinfo-item">
        <div>Liemenė:</div>
        <div class="vest-color-value">156</div>
    </div>
`;
gangDetailsContainer.appendChild(gangEquipmentSection);

// Add Binds Information
const bindsSection = document.createElement('div');
bindsSection.className = 'info-section mt-4';
bindsSection.innerHTML = `
    <h3>Bindai (spustelėkite, kad nukopijuoti)</h3>
    <div class="bind-box" onclick="copyBindToClipboard(this, 'bind keyboard 0 &quot;s ~ws~ ~b~ ~l~STOJI ~w~/ ~l~PAKELI ~w~RANKAS ~l~ARBA ~w~SAUDYSIM ~ws&quot;')">
        bind keyboard 0 "s ~ws~ ~b~ ~l~STOJI ~w~/ ~l~PAKELI ~w~RANKAS ~l~ARBA ~w~SAUDYSIM ~ws"
        <div class="copy-message">Nukopijuota!</div>
        <span class="copy-icon">📋</span>
    </div>
    <div class="bind-box" onclick="copyBindToClipboard(this, 'bind keyboard 9 &quot;s ~ws ~l~MIELA MALONU ~ws~&quot;')">
        bind keyboard 9 "s ~ws ~l~MIELA MALONU ~ws~"
        <div class="copy-message">Nukopijuota!</div>
        <span class="copy-icon">📋</span>
    </div>
`;
gangDetailsContainer.appendChild(bindsSection);

// Function to copy binds to clipboard
function copyBindToClipboard(element, text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show copy message
        const copyMessage = element.querySelector('.copy-message');
        copyMessage.style.display = 'block';
        
        // Hide copy message after 2 seconds
        setTimeout(() => {
            copyMessage.style.display = 'none';
        }, 2000);
    });
}

// Add this as a window function to be callable from HTML
window.copyBindToClipboard = copyBindToClipboard;
    async function handleDiscordAuthResponse() {
        try {
            // Parse the access token from the URL hash
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (!accessToken) {
                throw new Error('No access token found');
            }
            
            // Fetch user profile from Discord API
            const discordUser = await fetchDiscordUserProfile(accessToken);
            
            if (!discordUser || !discordUser.id) {
                throw new Error('Failed to get Discord user profile');
            }
            
            // Save user details to localStorage
            localStorage.setItem('discord_id', discordUser.id);
            localStorage.setItem('discord_username', discordUser.username);
            
            // Handle avatar URL
            const avatarUrl = discordUser.avatar 
                ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` 
                : '/api/placeholder/40/40';
            localStorage.setItem('discord_avatar', avatarUrl);
            
            // Update UI
            updateUserUI(discordUser.username, avatarUrl);
            hideLoginScreen();
            
            // Load dashboard data using Discord ID
            loadDashboardData(discordUser.id);
            logoutBtn.style.display = 'inline-block';
            
            // Clean URL after successful auth
            window.history.replaceState({}, document.title, window.location.pathname);
            
        } catch (err) {
            console.error('Error during Discord authentication:', err);
            showLoginError('Authentication failed. Please try again.');
            showLoginScreen();
        }
    }
    
    async function fetchDiscordUserProfile(accessToken) {
        try {
            const response = await fetch('https://discord.com/api/users/@me', {
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch Discord profile');
            }
            
            return await response.json();
        } catch (err) {
            console.error('Error fetching Discord profile:', err);
            throw err;
        }
    }
    
    function updateUserUI(username, avatarUrl) {
        userName.textContent = username || 'User';
        userAvatar.src = avatarUrl || '/api/placeholder/40/40';
    }
    
    // ===== UI FUNCTIONS =====
    
    function switchTab(selectedButton) {
        // Do nothing if not logged in
        if (loginScreen.style.display !== 'none') return;
        
        // Remove active class from all tabs
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        
        // Activate selected tab
        selectedButton.classList.add('active');
        const tabId = selectedButton.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
    }
    
    function hideLoginScreen() {
        loginScreen.style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        tabButtons[0].classList.add('active');
    }
    
    function showLoginScreen() {
        loginScreen.style.display = 'block';
        tabContents.forEach(content => content.classList.remove('active'));
        tabButtons.forEach(btn => btn.classList.remove('active'));
    }
    
    function showLoginError(message) {
        if (loginError) {
            loginError.textContent = message;
            loginError.style.display = 'block';
        }
    }
    
    // ===== DATA LOADING FUNCTIONS =====
    
    async function loadDashboardData(discordId) {
        try {
            await Promise.all([
                loadWarnings(discordId),
                loadIcInfo(discordId),
                loadRecentActivity(discordId)
            ]);
            
            // Update Discord server information
            updateDiscordInvite();
        } catch (err) {
            console.error('Error loading dashboard data:', err);
        }
    }
    
    // Modified to use custom proxy instead of Supabase
    async function loadWarnings(discordId) {
        try {
            // Ensure discordId is a string
            const stringDiscordId = String(discordId);
            
            // Fetch warnings using proxy API
            const response = await fetch(`${API_PROXY_URL}/Ispejimai?select=*&ID=eq.${stringDiscordId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch warnings: ${response.status}`);
            }
            
            const warnings = await response.json();
            
            // Update warnings count in dashboard
            const warningCount = document.getElementById('warningCount');
            if (warningCount) {
                warningCount.textContent = warnings ? warnings.length : 0;
                
                // Update status badge based on warning count
                const warningStatus = document.getElementById('warningStatus');
                if (warningStatus) {
                    if (!warnings || warnings.length === 0) {
                        warningStatus.textContent = 'Neturi ispėjimų';
                        warningStatus.className = 'status-badge badge-success';
                    } else if (warnings.length < 3) {
                        warningStatus.textContent = 'Normaliai ispėjimų';
                        warningStatus.className = 'status-badge badge-warning';
                    } else {
                        warningStatus.textContent = 'Per Daug ispėjimų';
                        warningStatus.className = 'status-badge badge-danger';
                    }
                }
            }
            
            // Update warnings tab
            updateWarningsTab(warnings || []);
            
            return warnings;
        } catch (err) {
            console.error('Error loading warnings:', err);
            // Make sure to update the UI even when there's an error
            updateWarningsTab([]);
            return [];
        }
    }

    function updateWarningsTab(warnings) {
        const warningsContainer = document.getElementById('warningsContainer');
        if (!warningsContainer) return;
        
        // Clear loading spinner and any existing content
        warningsContainer.innerHTML = '';
        
        if (!warnings || warnings.length === 0) {
            const noWarningsElement = document.createElement('div');
            noWarningsElement.className = 'warning-item';
            noWarningsElement.innerHTML = '<div class="warning-reason">Neturi Ispėjimų</div>';
            warningsContainer.appendChild(noWarningsElement);
        } else {
            warnings.forEach((warning, index) => {
                const warningElement = document.createElement('div');
                warningElement.className = 'warning-item';
                warningElement.style.setProperty('--item-delay', index);
                
                // Format date - add fallback for invalid dates
                let formattedDate = 'Unknown date';
                if (warning.DATA) {
                    try {
                        const date = new Date(warning.DATA);
                        formattedDate = date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                    } catch (err) {
                        console.error('Error formatting date:', err);
                    }
                }
                
                warningElement.innerHTML = `
                    <div class="warning-reason">${warning.PRIEŽASTIS || 'Unknown reason'}</div>
                    <div class="warning-date">${formattedDate}</div>
                `;
                
                warningsContainer.appendChild(warningElement);
            });
        }
    }

    // Modified to use custom proxy instead of Supabase
    async function loadIcInfo(discordId) {
        try {
            // Ensure discordId is a string
            const stringDiscordId = String(discordId);
            
            // Fetch IC info using proxy API
            const response = await fetch(`${API_PROXY_URL}/IC?select=*&DISCORD_ID=eq.${stringDiscordId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch IC info: ${response.status}`);
            }
            
            const icInfo = await response.json();
            
            // If no data found
            if (!icInfo) {
                throw new Error('No IC info found for this user');
            }
            
            // Update IC status in dashboard
            const icStatusIcon = document.getElementById('icStatusIcon');
            const icStatusBadge = document.getElementById('icStatusBadge');
            
            if (icStatusIcon && icStatusBadge && icInfo) {
                if (icInfo.STATUSAS === 'UŽPILDYTA') {
                    icStatusIcon.style.color = '#3ba55c';
                    icStatusBadge.textContent = 'Užpildyta';
                    icStatusBadge.className = 'status-badge badge-success';
                } else {
                    icStatusIcon.style.color = '#ed4245';
                    icStatusBadge.textContent = 'Neužpildyta';
                    icStatusBadge.className = 'status-badge badge-danger';
                }
            }
            
            // Update IC info tab
            updateIcInfoTab(icInfo);
            
            return icInfo;
        } catch (err) {
            console.error('Error loading IC info:', err);
            // Show default "not found" state in the IC info tab
            updateIcInfoTabNotFound();
            
            // Also update the dashboard icons to show inactive
            const icStatusIcon = document.getElementById('icStatusIcon');
            const icStatusBadge = document.getElementById('icStatusBadge');
            
            if (icStatusIcon && icStatusBadge) {
                icStatusIcon.style.color = '#ed4245';
                icStatusBadge.textContent = 'Not Found';
                icStatusBadge.className = 'status-badge badge-danger';
            }
            
            return null;
        }
    }

    // Add this function to handle the "not found" case
    function updateIcInfoTabNotFound() {
        const icStatusContainer = document.getElementById('icStatusContainer');
        const gangDetailsContainer = document.getElementById('gangDetailsContainer');
        
        if (!icStatusContainer || !gangDetailsContainer) return;
        
        // Clear loading spinners
        icStatusContainer.innerHTML = '';
        gangDetailsContainer.innerHTML = '';
        
        // Add "not found" message to IC status container
        const notFoundItem = document.createElement('div');
        notFoundItem.className = 'icinfo-item';
        notFoundItem.innerHTML = `
            <div>Status:</div>
            <div class="icinfo-status inactive-status">Not Found</div>
        `;
        icStatusContainer.appendChild(notFoundItem);
        
        // Add explanation to gang details container
        const explanationItem = document.createElement('div');
        explanationItem.className = 'icinfo-item';
        explanationItem.innerHTML = `
            <div>No character information found for your Discord account.</div>
        `;
        gangDetailsContainer.appendChild(explanationItem);
    }
    
    // Fixed updateIcInfoTab function
    function updateIcInfoTab(icInfo) {
        const icStatusContainer = document.getElementById('icStatusContainer');
        const gangDetailsContainer = document.getElementById('gangDetailsContainer');
        
        if (!icStatusContainer || !gangDetailsContainer) return;
        
        // Clear loading spinners
        icStatusContainer.innerHTML = '';
        gangDetailsContainer.innerHTML = '';
        
        // If icInfo is null or undefined, show "not found" message
        if (!icInfo) {
            updateIcInfoTabNotFound();
            return;
        }
        
        // Create status section
        const statusItem = document.createElement('div');
        statusItem.className = 'icinfo-item';
        statusItem.innerHTML = `
            <div>Statusas:</div>
            <div class="icinfo-status ${icInfo.STATUSAS === 'UŽPILDYTA' ? 'active-status' : 'inactive-status'}">
                ${icInfo.STATUSAS || 'Unknown'}
            </div>
        `;
        icStatusContainer.appendChild(statusItem);
        
        // Character name
        const characterNameItem = document.createElement('div');
        characterNameItem.className = 'icinfo-item';
        characterNameItem.innerHTML = `
            <div>Vardas Pavardė:</div>
            <div>${icInfo.VARDAS || 'Unknown'} ${icInfo.PAVARDĖ || ''}</div>
        `;
        icStatusContainer.appendChild(characterNameItem);
        
        // Steam Nickname - Fixed syntax error by using bracket notation
        const steamNicknameItem = document.createElement('div');
        steamNicknameItem.className = 'icinfo-item';
        steamNicknameItem.innerHTML = `
            <div>Steamo Nickas:</div>
            <div>${icInfo["STEAM NICKAS"] || 'Unknown'}</div>
        `;
        icStatusContainer.appendChild(steamNicknameItem);
        
        // Gang details - Rank
        const rankItem = document.createElement('div');
        rankItem.className = 'icinfo-item';
        rankItem.innerHTML = `
            <div>Rankas:</div>
            <div>${icInfo.RANKAS || 'None'}</div>
        `;
        gangDetailsContainer.appendChild(rankItem);
    }
    
    // Removed the initializeLinksTab function that was preventing links from working normally
    // Create the modal/popup markup first (add this inside the container div before the footer)
function initializeICFormPopup() {
    // Create popup container if it doesn't exist
    if (!document.getElementById('ic-form-popup')) {
        const popupHTML = `
        <div id="ic-form-popup" class="popup-container">
            <div class="popup-content">
                <div class="popup-header">
                    <h3>IC Info anketa</h3>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="popup-body">
                    <div class="form-group">
                        <label for="vardas">Vardas</label>
                        <input type="text" id="vardas" placeholder="Įveskite vardą" required>
                    </div>
                    <div class="form-group">
                        <label for="pavarde">Pavardė</label>
                        <input type="text" id="pavarde" placeholder="Įveskite pavardę" required>
                    </div>
                    <div class="form-group">
                        <label for="steam-nick">Steam Nickas</label>
                        <input type="text" id="steam-nick" placeholder="Įveskite Steam slapyvardį" required>
                    </div>
                    <div class="form-group">
                        <label for="steam-link">Steam Nuoroda</label>
                        <input type="url" id="steam-link" placeholder="https://steamcommunity.com/id/..." required>
                    </div>
                    <div id="ic-form-status" class="form-status"></div>
                    <button id="ic-submit-button" class="submit-button">
                        <span id="submit-text">Pateikti</span>
                        <span id="loading-spinner" class="spinner hidden"></span>
                    </button>
                </div>
            </div>
        </div>`;
        
        // Append the popup HTML to the body
        document.body.insertAdjacentHTML('beforeend', popupHTML);
        
        // Set up event listeners for the popup
        const popup = document.getElementById('ic-form-popup');
        const closeBtn = popup.querySelector('.close-btn');
        const submitBtn = document.getElementById('ic-submit-button');
        
        // Close popup when clicking X
        closeBtn.addEventListener('click', () => {
            popup.style.display = 'none';
        });
        
        // Close popup when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === popup) {
                popup.style.display = 'none';
            }
        });
        
        // Handle form submission
        submitBtn.addEventListener('click', submitICForm);
    }
}

// Function to show the IC form popup
function showICFormPopup() {
    initializeICFormPopup();
    document.getElementById('ic-form-popup').style.display = 'flex';
}

// Form validation
function validateICForm() {
    const inputs = document.querySelectorAll('#ic-form-popup input[required]');
    let isValid = true;
    
    inputs.forEach(input => {
        if (!input.value.trim()) {
            input.style.borderColor = 'rgba(237, 66, 69, 0.6)';
            input.style.boxShadow = '0 0 0 2px rgba(237, 66, 69, 0.2)';
            isValid = false;
        } else {
            input.style.borderColor = '';
            input.style.boxShadow = '';
        }
    });
    
    const steamLink = document.getElementById('steam-link');
    if (steamLink.value && !steamLink.value.includes('steamcommunity.com')) {
        steamLink.style.borderColor = 'rgba(237, 66, 69, 0.6)';
        steamLink.style.boxShadow = '0 0 0 2px rgba(237, 66, 69, 0.2)';
        isValid = false;
    }
    
    return isValid;
}

// Reset validation styles on input
function setupICFormValidation() {
    document.querySelectorAll('#ic-form-popup input').forEach(input => {
        input.addEventListener('input', function() {
            this.style.borderColor = '';
            this.style.boxShadow = '';
        });
    });
}

// Submit IC form data to Supabase
async function submitICForm() {
    // Validate inputs
    if (!validateICForm()) {
        showICFormStatus("Užpildykite visus laukelius teisingai", "error");
        return;
    }
    
    const vardas = document.getElementById("vardas").value.trim();
    const pavarde = document.getElementById("pavarde").value.trim();
    const steamNick = document.getElementById("steam-nick").value.trim();
    const steamLink = document.getElementById("steam-link").value.trim();
    
    // Get Discord ID and username from localStorage
    const discordId = localStorage.getItem('discord_id');
    const discordUsername = localStorage.getItem('discord_username');
    
    if (!discordId || !discordUsername) {
        showICFormStatus("Nepavyko gauti Discord informacijos", "error");
        return;
    }
    
    // Show loading state
    const submitButton = document.getElementById("ic-submit-button");
    const loadingSpinner = document.getElementById("loading-spinner");
    
    submitButton.disabled = true;
    submitButton.classList.add("loading");
    loadingSpinner.classList.remove("hidden");
    
    const formData = {
        DISCORD_ID: discordId,
        USERIS: discordUsername,
        VARDAS: vardas,
        PAVARDĖ: pavarde,
        "STEAM NICKAS": steamNick,
        "STEAM LINKAS": steamLink,
        STATUSAS: "UŽPILDYTA" // Set status to filled out
    };
    
    // Supabase configuration
    const SUPABASE_URL = 'https://smodsdsnswwtnbnmzhse.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtb2RzZHNuc3d3dG5ibm16aHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE2MjUyOTAsImV4cCI6MjA1NzIwMTI5MH0.zMdjymIaGU66_y6X-fS8nKnrWgJjXgw7NgXPBIzVCiI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    try {
        // Insert data into IC table
        const { data, error } = await supabase
            .from('IC')
            .insert([formData]);
        
        if (error) throw error;
        
        showICFormStatus("IC Info pateikta sėkmingai ✅", "success");
        
        // Reset form with smooth effect
        document.querySelectorAll('#ic-form-popup input').forEach(input => {
            input.value = "";
            input.style.borderColor = "";
            input.style.boxShadow = "";
        });
        
        // Close popup after successful submission
        setTimeout(() => {
            document.getElementById('ic-form-popup').style.display = 'none';
            
            // Refresh IC Info data
            const discordId = localStorage.getItem('discord_id');
            if (discordId) {
                loadIcInfo(discordId);
            }
        }, 2000);
        
    } catch (error) {
        console.error("Error submitting form:", error);
        showICFormStatus("Nepavyko išsiųsti duomenų. Bandykite vėliau.", "error");
    } finally {
        // Reset button state
        setTimeout(() => {
            submitButton.disabled = false;
            submitButton.classList.remove("loading");
            loadingSpinner.classList.add("hidden");
        }, 500);
    }
}

// Show status message in IC form
function showICFormStatus(message, type) {
    const statusElement = document.getElementById('ic-form-status');
    statusElement.textContent = message;
    statusElement.className = 'form-status';
    statusElement.classList.add(type);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        statusElement.textContent = '';
        statusElement.className = 'form-status';
    }, 5000);
}

// Modify the updateIcInfoTabNotFound function to include a button for the IC form
function updateIcInfoTabNotFound() {
    const icStatusContainer = document.getElementById('icStatusContainer');
    const gangDetailsContainer = document.getElementById('gangDetailsContainer');
    
    if (!icStatusContainer || !gangDetailsContainer) return;
    
    // Clear loading spinners
    icStatusContainer.innerHTML = '';
    gangDetailsContainer.innerHTML = '';
    
    // Add "not found" message to IC status container
    const notFoundItem = document.createElement('div');
    notFoundItem.className = 'icinfo-item';
    notFoundItem.innerHTML = `
        <div>Status:</div>
        <div class="icinfo-status inactive-status">Not Found</div>
    `;
    icStatusContainer.appendChild(notFoundItem);
    
    // Add explanation and button to gang details container
    const explanationItem = document.createElement('div');
    explanationItem.className = 'icinfo-item ic-missing-info';
    explanationItem.innerHTML = `
        <div>No character information found for your Discord account.</div>
        <button id="fill-ic-info-btn" class="fill-ic-btn">Užpildyti IC informaciją</button>
    `;
    gangDetailsContainer.appendChild(explanationItem);
    
    // Add event listener to the button
    const fillIcInfoBtn = document.getElementById('fill-ic-info-btn');
    if (fillIcInfoBtn) {
        fillIcInfoBtn.addEventListener('click', showICFormPopup);
    }
    
    // Initialize form popup
    initializeICFormPopup();
    setupICFormValidation();
}
    async function loadRecentActivity(discordId) {
        try {
            // For this function, assuming it's a nice-to-have feature
            // We'll implement a basic structure but make it fault-tolerant
            console.log('Loading recent activity for user:', discordId);
            
            // This is a placeholder - you can implement actual activity tracking later
            return [];
        } catch (err) {
            console.error('Error loading recent activity:', err);
            return [];
        }
    }
    // Add Discord server information update function
function updateDiscordInvite() {
  const inviteCode = "VfC3Ay86cW"; // Your invite code
  
  // Using Discord's invite widget endpoint (which sometimes allows CORS)
  fetch(`https://discordapp.com/api/invites/${inviteCode}?with_counts=true`)
    .then(response => response.json())
    .then(data => {
      // Update member counts with real data
      const serverMembers = document.querySelector('.server-members');
      if (serverMembers) {
        serverMembers.innerHTML = `
          <span class="online-indicator"></span>
          <span>${data.approximate_presence_count} Online</span>
          <span style="margin: 0 4px;">•</span>
          <span>${data.approximate_member_count} Members</span>
        `;
      }
      
      // Update server name if needed
      const serverName = document.querySelector('.discord-server-name');
      if (serverName && data.guild && data.guild.name) {
        serverName.textContent = data.guild.name;
      }
      
      // Update server icon if needed
      const serverIcon = document.querySelector('.discord-server-icon');
      if (serverIcon && data.guild && data.guild.icon) {
        const serverIconUrl = `https://cdn.discordapp.com/icons/${data.guild.id}/${data.guild.icon}.${data.guild.icon.startsWith('a_') ? 'gif' : 'png'}?size=1024`;
        serverIcon.src = serverIconUrl;
      }
    })
    .catch(error => {
      console.error('Error fetching Discord invite data:', error);
    });
}

// Add Copy to Clipboard function for binds
function copyToClipboard(text) {
    const el = event.currentTarget;
    const copyMessage = el.querySelector('.copy-message');
    
    navigator.clipboard.writeText(text).then(() => {
        // Show copy message
        copyMessage.style.display = 'block';
        
        // Hide copy message after 2 seconds
        setTimeout(() => {
            copyMessage.style.display = 'none';
        }, 2000);
    });
}

// Call the updateDiscordInvite function after authentication
function loadDashboardData(discordId) {
    try {
        Promise.all([
            loadWarnings(discordId),
            loadIcInfo(discordId),
            loadRecentActivity(discordId)
        ]).then(() => {
            // Update Discord server information after other data is loaded
            updateDiscordInvite();
        });
    } catch (err) {
        console.error('Error loading dashboard data:', err);
    }
}

// Make copyToClipboard accessible globally
window.copyToClipboard = copyToClipboard;
// ===== LOGOUT FUNCTION =====
    
    function logoutUser() {
        // Clear stored Discord data
        localStorage.removeItem('discord_id');
        localStorage.removeItem('discord_username');
        localStorage.removeItem('discord_avatar');
        
        // Reset UI
        userName.textContent = 'Neprisijungta';
        userAvatar.src = '/api/placeholder/40/40';
        logoutBtn.style.display = 'none';
        showLoginScreen();
    }
    
    // Setup link handling for links tab
  
    
// This is the closing bracket and parenthesis for the DOMContentLoaded event listener
});
    </script>
</body>
</html>
