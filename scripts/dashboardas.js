document.addEventListener("DOMContentLoaded",function(){const e=`https://discord.com/api/oauth2/authorize?client_id=1263389179249692693&redirect_uri=${encodeURIComponent(window.location.origin+window.location.pathname)}&response_type=token&scope=identify guilds.members.read`;const l=window.supabase.createClient("https://smodsdsnswwtnbnmzhse.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNtb2RzZHNuc3d3dG5ibm16aHNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE2MjUyOTAsImV4cCI6MjA1NzIwMTI5MH0.zMdjymIaGU66_y6X-fS8nKnrWgJjXgw7NgXPBIzVCiI"),a=document.querySelectorAll(".nav-button"),n=document.querySelectorAll(".tab-content"),i=document.getElementById("loginScreen");var t,r,o,s,d,c=document.getElementById("loginButton");const m=document.getElementById("userAvatar"),u=document.getElementById("userName"),g=document.getElementById("logoutBtn"),p=document.getElementById("loginError"),v=document.getElementById("warningsContainer"),y=document.getElementById("icStatusContainer"),f=document.getElementById("gangDetailsContainer");function h(e,t,a,n,i){n&&i&&a?u.innerHTML=`
                <div class="user-container">
                    <span class="primary-user-badge">
                        <img class="badge-icon" src="https://cdn.discordapp.com/clan-badges/${n}/${i}.png?size=16" 
                             onerror="this.onerror=null; this.src='/api/placeholder/16/16';" alt="badge">
                        <span class="badge-text">${a}</span>
                    </span>
                    <span class="username-text">${e||"User"}</span>
                </div>
            `:u.textContent=e||"User",m.src=t||"/api/placeholder/40/40"}function I(){i.style.display="none",document.getElementById("dashboard").classList.add("active"),a[0].classList.add("active")}function b(){i.style.display="block",n.forEach(e=>e.classList.remove("active")),a.forEach(e=>e.classList.remove("active"))}async function S(e){try{await Promise.all([async function(a){try{var n=String(a);let{data:e,error:t}=await l.from("Ispejimai").select("*").filter("ID","eq",n).order("DATA",{ascending:!1});if(t&&(console.warn("First warning query failed, trying alternative method:",t),{data:e,error:t}=await l.from("Ispejimai").select("*").eq("ID",n).order("DATA",{ascending:!1})),t)throw t;var i,r=document.getElementById("warningCount");return r&&(r.textContent=e?e.length:0,i=document.getElementById("warningStatus"))&&(e&&0!==e.length?e.length<3?(i.textContent="Normaliai ispėjimų",i.className="status-badge badge-warning"):(i.textContent="Per Daug ispėjimų",i.className="status-badge badge-danger"):(i.textContent="Neturi ispėjimų",i.className="status-badge badge-success")),E(e||[]),e}catch(e){return console.error("Error loading warnings:",e),E([]),[]}}(e),w(e),async function(e){try{return console.log("Loading recent activity for user:",e),[]}catch(e){return console.error("Error loading recent activity:",e),[]}}(e)]),fetch("https://discordapp.com/api/invites/VfC3Ay86cW?with_counts=true").then(e=>e.json()).then(e=>{var t=document.querySelector(".server-members"),t=(t&&(t.innerHTML=`
                        <span class="online-indicator"></span>
                        <span>${e.approximate_presence_count} Online</span>
                        <span style="margin: 0 4px;">•</span>
                        <span>${e.approximate_member_count} Members</span>
                    `),document.querySelector(".discord-server-name")),t=(t&&e.guild&&e.guild.name&&(t.textContent=e.guild.name),document.querySelector(".discord-server-icon"));t&&e.guild&&e.guild.icon&&(e=`https://cdn.discordapp.com/icons/${e.guild.id}/${e.guild.icon}.${e.guild.icon.startsWith("a_")?"gif":"png"}?size=1024`,t.src=e)}).catch(e=>{console.error("Error fetching Discord invite data:",e)})}catch(e){console.error("Error loading dashboard data:",e)}}function E(e){v&&(v.innerHTML="",e&&0!==e.length?e.forEach((e,t)=>{var a=document.createElement("div");a.className="warning-item",a.style.setProperty("--item-delay",t);let n="Unknown date";if(e.DATA)try{var i=new Date(e.DATA);n=i.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch(e){console.error("Error formatting date:",e)}a.innerHTML=`
                    <div class="warning-reason">${e.PRIEŽASTIS||"Unknown reason"}</div>
                    <div class="warning-date">${n}</div>
                `,v.appendChild(a)}):((e=document.createElement("div")).className="warning-item",e.innerHTML='<div class="warning-reason">Neturi Ispėjimų</div>',v.appendChild(e)))}async function w(a){try{var n,i,r=String(a);let{data:e,error:t}=await l.from("IC").select("*").filter("DISCORD_ID","eq",r);if((t||Array.isArray(e)&&0===e.length)&&(console.log("First IC query attempt failed, trying text comparison:",t),{data:e,error:t}=await l.from("IC").select("*").ilike("ID",r),t||Array.isArray(e)&&0===e.length)){console.log("Second IC query attempt failed, trying direct query:",t);try{var{data:o,error:s}=await l.rpc("get_ic_info_by_discord_id",{discord_id_param:r});!s&&o&&0<o.length&&(e=o,t=null)}catch(e){console.warn("RPC call failed:",e)}}if(Array.isArray(e)&&0<e.length&&(e=e[0]),t)throw t;if(e)return n=document.getElementById("icStatusIcon"),i=document.getElementById("icStatusBadge"),n&&i&&e&&("UŽPILDYTA"===e.STATUSAS?(n.style.color="#3ba55c",i.textContent="Užpildyta",i.className="status-badge badge-success"):(n.style.color="#ed4245",i.textContent="Neužpildyta",i.className="status-badge badge-danger")),d=e,y&&f&&(y.innerHTML="",f.innerHTML="",d?((c=document.createElement("div")).className="icinfo-item",c.innerHTML=`
            <div>Statusas:</div>
            <div class="icinfo-status ${"UŽPILDYTA"===d.STATUSAS?"active-status":"inactive-status"}">
                ${d.STATUSAS||"Unknown"}
            </div>
        `,y.appendChild(c),(c=document.createElement("div")).className="icinfo-item",c.innerHTML=`
            <div>Vardas Pavardė:</div>
            <div>${d.VARDAS||"Unknown"} ${d.PAVARDĖ||""}</div>
        `,y.appendChild(c),(c=document.createElement("div")).className="icinfo-item",c.innerHTML=`
            <div>Steamo Nickas:</div>
            <div>${d["STEAM NICKAS"]||"Unknown"}</div>
        `,y.appendChild(c),(c=document.createElement("div")).className="icinfo-item",c.innerHTML=`
            <div>Rankas:</div>
            <div>${d.RANKAS||"None"}</div>
        `,f.appendChild(c)):_()),e;throw new Error("No IC info found for this user")}catch(e){console.error("Error loading IC info:",e),_();a=document.getElementById("icStatusIcon"),r=document.getElementById("icStatusBadge");return a&&r&&(a.style.color="#ed4245",r.textContent="Not Found",r.className="status-badge badge-danger"),null}var d,c}function _(){var e;y&&f&&(y.innerHTML="",f.innerHTML="",(e=document.createElement("div")).className="icinfo-item",e.innerHTML=`
            <div>Statusas:</div>
            <div class="icinfo-status inactive-status">Not Found</div>
        `,y.appendChild(e),(e=document.createElement("div")).className="icinfo-item ic-missing-info",e.innerHTML=`
            <div>No character information found for your Discord account.</div>
            <button id="fill-ic-info-btn" class="fill-ic-btn">Užpildyti IC informaciją</button>
        `,f.appendChild(e),(e=document.getElementById("fill-ic-info-btn"))&&e.addEventListener("click",C),A(),document.querySelectorAll("#ic-form-popup input").forEach(e=>{e.addEventListener("input",function(){this.style.borderColor="",this.style.boxShadow=""})}))}function A(){if(!document.getElementById("ic-form-popup")){document.body.insertAdjacentHTML("beforeend",`
            <div id="ic-form-popup" class="popup-container">
                <div class="popup-content">
                    <div class="popup-header">
                        <h3>IC Info anketa</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div class="popup-body">
                        <div class="form-group">
                            <label for="vardas">Vardas</label>
                            <input type="text" id="vardas" placeholder="Įveskite vardą" required>
                        </div>
                        <div class="form-group">
                            <label for="pavarde">Pavardė</label>
                            <input type="text" id="pavarde" placeholder="Įveskite pavardę" required>
                        </div>
                        <div class="form-group">
                            <label for="steam-nick">Steam Nickas</label>
                            <input type="text" id="steam-nick" placeholder="Įveskite Steam slapyvardį" required>
                        </div>
                        <div class="form-group">
                            <label for="steam-link">Steam Nuoroda</label>
                            <input type="url" id="steam-link" placeholder="https://steamcommunity.com/id/..." required>
                        </div>
                        <div id="ic-form-status" class="form-status"></div>
                        <button id="ic-submit-button" class="submit-button">
                            <span id="submit-text">Pateikti</span>
                            <span id="loading-spinner" class="spinner hidden"></span>
                        </button>
                    </div>
                </div>
            </div>`);const a=document.getElementById("ic-form-popup");var e=a.querySelector(".close-btn"),t=document.getElementById("ic-submit-button");e.addEventListener("click",()=>{a.style.display="none"}),window.addEventListener("click",e=>{e.target===a&&(a.style.display="none")}),t.addEventListener("click",k)}}function C(){A(),document.getElementById("ic-form-popup").style.display="flex"}async function k(){if(function(){var e=document.querySelectorAll("#ic-form-popup input[required]");let t=!0;return e.forEach(e=>{e.value.trim()?(e.style.borderColor="",e.style.boxShadow=""):(e.style.borderColor="rgba(237, 66, 69, 0.6)",e.style.boxShadow="0 0 0 2px rgba(237, 66, 69, 0.2)",t=!1)}),(e=document.getElementById("steam-link")).value&&!e.value.includes("steamcommunity.com")&&(e.style.borderColor="rgba(237, 66, 69, 0.6)",e.style.boxShadow="0 0 0 2px rgba(237, 66, 69, 0.2)",t=!1),t}()){var e=document.getElementById("vardas").value.trim(),t=document.getElementById("pavarde").value.trim(),a=document.getElementById("steam-nick").value.trim(),n=document.getElementById("steam-link").value.trim(),i=localStorage.getItem("discord_id"),r=localStorage.getItem("discord_username");if(i&&r){const s=document.getElementById("ic-submit-button"),d=document.getElementById("loading-spinner");s.disabled=!0,s.classList.add("loading"),d.classList.remove("hidden");i={DISCORD_ID:i,USERIS:r,VARDAS:e,"PAVARDĖ":t,"STEAM NICKAS":a,"STEAM LINKAS":n,STATUSAS:"UŽPILDYTA"};try{var o=(await l.from("IC").insert([i])).error;if(o)throw o;L("IC Info pateikta sėkmingai ✅","success"),document.querySelectorAll("#ic-form-popup input").forEach(e=>{e.value="",e.style.borderColor="",e.style.boxShadow=""}),setTimeout(()=>{document.getElementById("ic-form-popup").style.display="none";var e=localStorage.getItem("discord_id");e&&w(e)},2e3)}catch(e){console.error("Error submitting form:",e),L("Nepavyko išsiųsti duomenų. Bandykite vėliau.","error")}finally{setTimeout(()=>{s.disabled=!1,s.classList.remove("loading"),d.classList.add("hidden")},500)}}else L("Nepavyko gauti Discord informacijos","error")}else L("Užpildykite visus laukelius teisingai","error")}function L(e,t){const a=document.getElementById("ic-form-status");a.textContent=e,a.className="form-status",a.classList.add(t),setTimeout(()=>{a.textContent="",a.className="form-status"},5e3)}a.forEach(t=>{t.addEventListener("click",()=>{var e;e=t,"none"===i.style.display&&(a.forEach(e=>e.classList.remove("active")),n.forEach(e=>e.classList.remove("active")),e.classList.add("active"),e=e.getAttribute("data-tab"),document.getElementById(e).classList.add("active"))})}),c.addEventListener("click",function(){window.location.href=e}),g&&g.addEventListener("click",function(){localStorage.removeItem("discord_id"),localStorage.removeItem("discord_username"),localStorage.removeItem("discord_avatar"),localStorage.removeItem("discord_guild_tag"),localStorage.removeItem("discord_server_id"),localStorage.removeItem("discord_badge_hash"),u.textContent="Neprisijungta",m.src="/api/placeholder/40/40",g.style.display="none",b()}),window.location.hash.includes("access_token=")?async function(){try{var n=window.location.hash.substring(1),i=new URLSearchParams(n).get("access_token");if(!i)throw new Error("No access token found");var r=await async function(e){try{var t=await fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+e}});if(t.ok)return await t.json();throw new Error("Failed to fetch Discord profile: "+t.statusText)}catch(e){throw console.error("Error fetching Discord profile:",e),e}}(i);if(!r||!r.id)throw new Error("Failed to get Discord user profile");var o=await async function(e,t){try{var a=await fetch(`https://discord.com/api/users/@me/guilds/${t}/member`,{headers:{Authorization:"Bearer "+e}});return a.ok?await a.json():(console.warn(`Could not fetch guild member info for guild ${t}: `+a.statusText),null)}catch(e){return console.error("Error fetching Discord guild member info:",e),null}}(i,(r.id,"1325850250027597845"));let e=null,t=null,a=null;o&&"1325850250027597845"===o.guild_id&&(e=o.guild_member_flags?"Member":null,t="1325850250027597845",a="a_390be3fdaab65e28c28d150ca21d93bb",o.nick?e=o.nick.split(" ")[0]:o.roles&&0<o.roles.length&&(e="Rank")),localStorage.setItem("discord_id",r.id),localStorage.setItem("discord_username",r.global_name||r.username),localStorage.setItem("discord_guild_tag",e),localStorage.setItem("discord_server_id",t),localStorage.setItem("discord_badge_hash",a);var s=r.avatar?`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}.png`:"/api/placeholder/40/40";localStorage.setItem("discord_avatar",s),h(r.global_name||r.username,s,e,t,a),I(),S(r.id),g.style.display="inline-block",window.history.replaceState({},document.title,window.location.pathname)}catch(e){console.error("Error during Discord authentication:",e),p&&(p.textContent="Authentication failed. Please try again.",p.style.display="block"),b()}}():(c=localStorage.getItem("discord_id"),t=localStorage.getItem("discord_username"),r=localStorage.getItem("discord_avatar"),o=localStorage.getItem("discord_guild_tag"),s=localStorage.getItem("discord_server_id"),d=localStorage.getItem("discord_badge_hash"),c?(h(t,r,o,s,d),I(),S(c),g.style.display="inline-block"):(b(),g.style.display="none")),window.copyToClipboard=function(e){const t=event.currentTarget.querySelector(".copy-message");navigator.clipboard.writeText(e).then(()=>{t.style.display="block",setTimeout(()=>{t.style.display="none"},2e3)})}});
