document.addEventListener("DOMContentLoaded",async function(){console.log("✅ DOM fully loaded!");const u={API:{STATUS_ENDPOINT:"https://supa.mielamalonu.com/api/supabase/Status",BLACKLIST_ENDPOINT:"https://supa.mielamalonu.com/api/supabase/Blacklist",ROLE_CHECK_ENDPOINT:"https://mmapi-production.up.railway.app/api/check-role",SUBMIT_ENDPOINT:"https://api.mielamalonu.com/send-to-botghost",API_KEY:"cbb"},DISCORD:{CLIENT_ID:"1263389179249692693",REDIRECT_URI:window.location.origin+window.location.pathname,SCOPES:["identify","guilds.members.read","guilds.join"],WEBHOOK_URL:"https://canary.discord.com/api/webhooks/1346529699081490472/k-O-v4wKDiUjsj1w-Achvrej1Kr-W-rXqZVibcftwWFn5sMZyhIMSb9E4r975HbQI3tF",GUILD_ID:"1325850250027597845",PROXY_URL:"https://add.mielamalonu.com/api/discord/join-server"}},l={form:document.getElementById("applicationForm"),statusDisplay:document.getElementById("statusDisplay"),discordButton:document.getElementById("discord-login"),profileContainer:document.getElementById("profile-container"),responseMessage:document.createElement("p"),notification:document.getElementById("notification"),notificationMessage:document.querySelector(".notification-message"),notificationIcon:document.querySelector(".notification-icon"),steps:document.querySelectorAll(".step"),formSteps:document.querySelectorAll(".form-step"),nextStep1Button:document.getElementById("next-step-1"),nextStep2Button:document.getElementById("next-step-2"),prevStep2Button:document.getElementById("prev-step-2"),prevStep3Button:document.getElementById("prev-step-3"),submitButton:document.getElementById("submitButton"),plStars:document.querySelectorAll("#pl-stars i"),klStars:document.querySelectorAll("#kl-stars i"),pcToggle:document.getElementById("pc-toggle"),ispToggle:document.getElementById("isp-toggle"),ageInput:document.getElementById("age"),plInput:document.getElementById("pl"),klInput:document.getElementById("kl"),whyJoinInput:document.getElementById("whyJoin"),pcInput:document.getElementById("pc"),ispInput:document.getElementById("isp"),reviewDiscord:document.getElementById("review-discord"),reviewAge:document.getElementById("review-age"),reviewPl:document.getElementById("review-pl"),reviewKl:document.getElementById("review-kl"),reviewWhyJoin:document.getElementById("review-whyJoin"),reviewPc:document.getElementById("review-pc"),reviewIsp:document.getElementById("review-isp")};let d={blacklist:[],lastStatus:null,currentUser:null,updateInterval:null,isSubmitting:!1,currentStep:1,formData:{pl:0,kl:0}};if(l.form.appendChild(l.responseMessage),l.form.addEventListener("submit",n),l.discordButton.addEventListener("click",i),l.nextStep1Button.addEventListener("click",()=>{d.currentUser?k(2):y("Prašome prisijungti su Discord prieš tęsiant")}),l.nextStep2Button.addEventListener("click",()=>{!function(){if(!l.ageInput.value||l.ageInput.value<13)return void y("❌ Amžius privalo būti bent 13 metų");if(!l.plInput.value||"0"===l.plInput.value)return void y("❌ Prašome įvertinti savo pašaudimo lygį");if(!l.klInput.value||"0"===l.klInput.value)return void y("❌ Prašome įvertinti savo komunikacijos lygį");if(!l.whyJoinInput.value||l.whyJoinInput.value.trim().length<10)return void y("❌ Prašome išsamiau aprašyti kodėl norite prisijungti");l.pcInput.value.trim()||(l.pcInput.value="Ne");l.ispInput.value.trim()||(l.ispInput.value="Ne");return I("success","✅ Visi laukai užpildyti teisingai!"),f(),1}()||(l.reviewAge&&(l.reviewAge.textContent=l.ageInput.value||"N/A"),l.reviewPl&&(l.reviewPl.textContent=`${l.plInput.value||"0"}/10`),l.reviewKl&&(l.reviewKl.textContent=`${l.klInput.value||"0"}/10`),l.reviewWhyJoin&&(l.reviewWhyJoin.textContent=l.whyJoinInput.value||"N/A"),l.reviewPc&&(l.reviewPc.textContent=l.pcInput.value||"N/A"),l.reviewIsp&&(l.reviewIsp.textContent=l.ispInput.value||"N/A"),k(3))}),l.prevStep2Button.addEventListener("click",()=>k(1)),l.prevStep3Button.addEventListener("click",()=>k(2)),l.submitButton.addEventListener("click",e=>{e.preventDefault(),l.form.dispatchEvent(new Event("submit",{cancelable:!0}))}),(e=(t,a)=>{t.forEach(e=>{e.addEventListener("click",function(){var e=parseInt(this.getAttribute("data-value"));w(t,e),a.value=e}),e.addEventListener("mouseover",function(){var e=parseInt(this.getAttribute("data-value"));b(t,e)}),e.addEventListener("mouseout",function(){var e=parseInt(a.value)||0;b(t,e)})})})(l.plStars,l.plInput),e(l.klStars,l.klInput),l.pcToggle.addEventListener("change",function(){l.pcInput.value=this.checked?"Taip":"Ne"}),l.ispToggle.addEventListener("change",function(){l.ispInput.value=this.checked?"Taip":"Ne"}),l.whyJoinInput.addEventListener("input",function(){S(this)}),window.location.hash){var e=new URLSearchParams(window.location.hash.substring(1)),t=e.get("access_token");const d=e.get("state");e=localStorage.getItem("discord_auth_state");localStorage.removeItem("discord_auth_state"),t&&d&&d===e?(console.log("Successfully obtained token from URL fragment"),r(t)):t&&(console.warn("State validation failed, potential CSRF attack"),I("error","Authentication failed: security check failed"))}else g(d.currentUser);function c(e,t){return console.log("Checking blacklist for user:",e),console.log("Blacklist array:",t),!(!e||!Array.isArray(t)||0===t.length)&&(e=String(e).trim(),t=t.includes(e),console.log(`Is user ${e} blacklisted?`,t),t)}async function a(){try{console.log("Fetching status and blacklist...");var a=await fetch(u.API.STATUS_ENDPOINT);if(!a.ok)throw new Error("Failed to fetch status");var n=await a.json();console.log("Status data received:",n);let e="offline";Array.isArray(n)&&0<n.length&&n[0]&&n[0].status&&(e="online"===n[0].status.toLowerCase()?"online":"offline");var i=await fetch(u.API.BLACKLIST_ENDPOINT);if(!i.ok)throw new Error("Failed to fetch blacklist");var r=await i.json();console.log("Raw blacklist data received:",r);let t=[];var o,s,l,c=e=>"string"==typeof e?e.split(",").map(e=>e.trim()).filter(e=>e):Array.isArray(e)?e.map(e=>String(e).trim()).filter(e=>e):[];Array.isArray(r)&&0<r.length?"object"==typeof(o=r[0])&&null!==o?(s=o.blacklistedIds||o.ids||o.blacklist)&&(t=c(s)):t=c(r):"object"==typeof r&&null!==r?(l=r.blacklistedIds||r.ids||r.blacklist)&&(t=c(l)):"string"==typeof r&&(t=c(r)),console.log("Processed blacklist into array:",t),p({status:e,blacklist:t})}catch(e){console.error("❌ Status fetch error:",e),p({status:"offline",blacklist:d.blacklist||[]}),I("error","Nepavyko gauti aplikacijos statuso. Bandykite vėliau.")}}function p(e){var t=e.blacklist||[];d.lastStatus===e.status&&JSON.stringify(d.blacklist)===JSON.stringify(t)||(d.lastStatus=e.status,d.blacklist=t,"online"===d.lastStatus?(l.statusDisplay.textContent="✅ Atidaryta ✅",l.statusDisplay.className="status-online"):(l.statusDisplay.textContent="❌ Uždaryta ❌",l.statusDisplay.className="status-offline"),m())}function m(){if(l.form){var t=!!d.currentUser;console.log("Form state check - User logged in:",t);let e=!1;t&&d.currentUser.id&&(e=c(d.currentUser.id,d.blacklist),console.log("Form state check - User blacklisted:",e));var a="online"===d.lastStatus,a=(console.log("Form state check - App online:",a),!t||e||!a||d.isSubmitting);l.submitButton&&(l.submitButton.disabled=a),console.log("Submit button disabled:",a),l.nextStep1Button&&(l.nextStep1Button.disabled=!t||e),e?(I("error","🚫 Jūs esate įtrauktas į juodąjį sąrašą ir negalite teikti anketos!"),l.form&&(l.form.style.pointerEvents="none",l.form.style.opacity="0.5")):l.form&&(l.form.style.pointerEvents="auto",l.form.style.opacity="1")}}async function n(e){if(e.preventDefault(),!d.isSubmitting){d.isSubmitting=!0,f();const s=l.submitButton;s.disabled=!0,s.textContent="Pateikiama...",document.getElementById("formLoader").style.display="flex",document.body.style.overflow="hidden";try{if(console.log("Validating all requirements..."),!d.currentUser||!d.currentUser.id)throw new Error("Discord authentication required");var t=c(d.currentUser.id,d.blacklist);if(console.log("Final blacklist check before submission:",t),t)throw I("error","🚫 Jūs esate užblokuotas ir negalite pateikti anketos!"),new Error("User blacklisted");try{var a=await fetch(u.API.ROLE_CHECK_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:d.currentUser.id})});if(!a.ok)throw I("error","Serverio klaida tikrinant naudotojo rolę"),new Error("Server error while checking role");if((await a.json()).hasRole)throw new Error("LA")}catch(e){throw"LA"!==e.message&&I("error","Nepavyko patikrinti naudotojo informacijos"),e}await 0;var n={userId:d.currentUser.id,age:l.ageInput.value.trim(),reason:l.whyJoinInput.value.trim(),pl:l.plInput.value.trim(),kl:l.klInput.value.trim(),pc:l.pcInput.value.trim(),isp:l.ispInput.value.trim()};try{var i=d.currentUser.id.slice(0,16)+"-"+Date.now(),r={variables:[{name:"userId",variable:"{event_userId}",value:""+n.userId},{name:"age",variable:"{event_age}",value:""+n.age},{name:"reason",variable:"{event_reason}",value:""+n.reason},{name:"pl",variable:"{event_pl}",value:n.pl+"/10"},{name:"kl",variable:"{event_kl}",value:n.kl+"/10"},{name:"pc",variable:"{event_pc}",value:""+n.pc},{name:"isp",variable:"{event_isp}",value:""+n.isp},{name:"applicationId",variable:"{event_appId}",value:i}]};if(!(await fetch(u.API.SUBMIT_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Authorization:u.API.API_KEY},body:JSON.stringify(r)})).ok)throw I("error","API klaida pateikiant anketą"),new Error("API error")}catch(e){throw console.error("Submission error:",e),e}await 0,s.textContent="Pateikta!",I("success","✅ Aplikacija sėkmingai pateikta!"),l.form.reset(),w(l.plStars,0),w(l.klStars,0),l.plInput.value="0",l.klInput.value="0",l.pcToggle.checked=!1,l.ispToggle.checked=!1,S(l.whyJoinInput),f(),k(1)}catch(e){var o=e;switch(console.error("Submission error:",o),o.message){case"Discord authentication required":y("❌ Prieš pateikiant anketą, reikia prisijungti per Discord!");break;case"Applications closed":y("❌ Anketų pildymas šiuo metu yra sustabdytas.");break;case"User blacklisted":y("🚫 Jūs esate užblokuotas ir negalite pateikti anketos!");break;case"LA":y("❌ Jūs jau esate mūsų gaujos narys arba jūsų anketa yra peržiūrima!");break;default:y("❌ Įvyko klaida pateikiant anketą. Bandykite dar kartą.")}s.textContent="Bandykite dar kartą"}finally{document.getElementById("formLoader").style.display="none",document.body.style.overflow="auto",setTimeout(()=>{d.isSubmitting=!1,s.textContent="Pateikti aplikaciją",s.disabled=!1,m()},3e3)}}}function i(){localStorage.removeItem("discord_token"),localStorage.removeItem("discord_token_expiry");var e=new URL("https://discord.com/api/oauth2/authorize"),t=(e.searchParams.append("client_id",u.DISCORD.CLIENT_ID),e.searchParams.append("redirect_uri",u.DISCORD.REDIRECT_URI),e.searchParams.append("response_type","token"),e.searchParams.append("scope",u.DISCORD.SCOPES.join(" ")),Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15));localStorage.setItem("discord_auth_state",t),e.searchParams.append("state",t),console.log("Redirecting to Discord OAuth:",e.toString()),window.location.href=e.toString()}async function r(e){try{I("info","Authenticating with Discord...");var t=await o(e);if(!t||!t.id)throw new Error("Failed to fetch user data");d.currentUser={...t,accessToken:e},console.log("User authenticated, ID:",t.id),g(d.currentUser),I("info","Attempting to add you to Discord server..."),await async function(e,t){try{I("info","Connecting to Discord server...");var a,n,i={userId:e,accessToken:t},r=(console.log("Sending join request to proxy:",{userId:e,tokenPresent:!!t,proxyUrl:u.DISCORD.PROXY_URL}),await fetch(u.DISCORD.PROXY_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}));if(r.ok)return n=await r.json(),console.log("Proxy server response:",n),n.success;try{a=await r.json(),console.error("Error from proxy server:",a),a.error&&50025===a.error.code?I("error","Invalid OAuth token. Try logging out and in again."):I("error","Server error: "+(a.message||"Unknown error"))}catch(e){console.error("Failed to parse error response:",e),I("error",`Server error (${r.status}): Could not process response`)}return!1}catch(e){return console.error("Error adding user to server via proxy:",e),I("error","Connection error. Please try again later."),!1}}(t.id,e)?I("success","Successfully joined Discord server!"):I("warning","Could not add you to the server automatically. Please join manually if needed."),window.history.replaceState({},document.title,window.location.pathname),d.updateInterval&&clearInterval(d.updateInterval),d.updateInterval=setInterval(s,5e7),m()}catch(e){console.error("Auth redirect error:",e),y("Failed to authenticate with Discord: "+e.message),window.history.replaceState({},document.title,window.location.pathname)}}async function o(e){try{var t,a,n,[i,r]=await Promise.all([fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+e}}),fetch(`https://discord.com/api/v10/users/@me/guilds/${u.DISCORD.GUILD_ID}/member`,{headers:{Authorization:"Bearer "+e}})]),o=await i.json(),s=await r.json();if(o.id)return t=s.presence?.status||"offline",n=(a=s.activities||[]).find(e=>0===e.type)||{},{...o,avatar:`https://cdn.discordapp.com/avatars/${o.id}/${o.avatar}.png?size=256`,status:t,activities:a,activity:{name:n.name||"",details:n.details||"",state:n.state||"",emoji:n.emoji?.name||"🎮"}};throw I("error","Nepavyko gauti Discord naudotojo informacijos"),new Error("Invalid user data")}catch(e){return console.error("Discord API error:",e),I("error","Nepavyko prisijungti prie Discord. Bandykite vėliau."),{status:"offline",activities:[]}}}async function s(){if(d.currentUser)try{var e=await o(d.currentUser.accessToken);e.status===d.currentUser.status&&JSON.stringify(e.activities)===JSON.stringify(d.currentUser.activities)||(d.currentUser={...e,accessToken:d.currentUser.accessToken},g(d.currentUser))}catch(e){console.error("Presence update error:",e)}}function v(){clearInterval(d.updateInterval),g(d.currentUser=null),location.reload()}function g(e){e&&(l.profileContainer.innerHTML=`
                <div class="avatar-wrapper">
                    <img src="${e.avatar}" alt="Avatar">
                    <div class="status-dot ${e.status}"></div>
                </div>
                <div class="user-info">
                    <p class="username">${e.global_name||e.username}</p>
                    ${"dnd"===e.status?'<div class="dnd-banner">Do Not Disturb</div>':""}
                </div>
                <button id="logout">Atsijungti</button>
            `,document.getElementById("logout").addEventListener("click",v),l.reviewDiscord&&(l.reviewDiscord.textContent=e.global_name||e.username),I("success","Sėkmingai prisijungta prie Discord!")),e=!!e,l.discordButton.style.display=e?"none":"block",l.profileContainer.style.display=e?"flex":"none",m()}function f(){l.responseMessage.textContent="",l.responseMessage.className="",h()}function y(e){l.responseMessage.textContent=e,l.responseMessage.className="error-message",I("error",e)}function I(e,t){if(l.notification&&l.notificationMessage&&l.notificationIcon){switch(l.notificationMessage.textContent=t,l.notification.className="notification",l.notification.classList.add("notification-"+e),e){case"success":l.notificationIcon.className="notification-icon fas fa-check-circle";break;case"error":l.notificationIcon.className="notification-icon fas fa-exclamation-circle";break;case"warning":l.notificationIcon.className="notification-icon fas fa-exclamation-triangle";break;default:l.notificationIcon.className="notification-icon fas fa-info-circle"}l.notification.classList.add("show"),"success"!==e&&"info"!==e||setTimeout(h,5e3)}}function h(){l.notification&&l.notification.classList.remove("show")}function k(a){d.currentStep=a,l.formSteps.forEach(e=>{e.style.display="none"}),document.getElementById("step-"+a).style.display="block",l.steps.forEach(e=>{var t=parseInt(e.getAttribute("data-step"));e.classList.remove("active","completed"),t<a?e.classList.add("completed"):t===a&&e.classList.add("active")}),f()}function w(e,t){}function b(e,t){}function S(e){}function w(e,t){b(e,t)}function b(e,t){e.forEach(e=>{parseInt(e.getAttribute("data-value"))<=t?(e.classList.remove("far"),e.classList.add("fas")):(e.classList.remove("fas"),e.classList.add("far"))})}function S(e){var t=e.value.length,a=e.parentElement.querySelector(".char-count");a&&(a.textContent=t+"/200",200<t?(a.classList.add("char-limit-exceeded"),e.value=e.value.substring(0,200),S(e),I("warning","Pasiektas maksimalus simbolių skaičius (200)")):a.classList.remove("char-limit-exceeded"))}setInterval(a,5e3),a()});
