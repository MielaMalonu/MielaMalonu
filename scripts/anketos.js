const DEBUG=!0;function debug(...e){DEBUG&&console.log("DEBUG:",...e)}debug("Script started");const API_BASE_URL="https://supa.mielamalonu.com/api/supabase",API_KEY="cbb",DISCORD_CLIENT_ID="1263389179249692693",DISCORD_REDIRECT_URI=encodeURIComponent(window.location.origin+window.location.pathname),ADMIN_DISCORD_ID="959449311366766622";let discordToken=null,discordUserId=null,pendingAppIdToDelete=null,authWindow=null;function getQueryParam(e){return new URLSearchParams(window.location.search).get(e)}function getStatusClass(e){return e?(e=e.toLowerCase()).includes("patvirtinta")||e.includes("priimtas")||e.includes("accepted")?"status-accepted":e.includes("atmesta")||e.includes("atmestas")||e.includes("rejected")?"status-rejected":e.includes("laukiama")||e.includes("pending")?"status-pending":"status-reviewing":"status-reviewing"}function formatDate(t){if(!t)return"N/A";try{return new Date(t).toISOString().split("T")[0]}catch(e){return t}}function showOAuthPopup(){debug("Showing OAuth popup"),document.getElementById("oauth-popup").classList.remove("hidden")}function hideOAuthPopup(){debug("Hiding OAuth popup"),document.getElementById("oauth-popup").classList.add("hidden")}function showStatusMessage(e,t=!1){debug("Status message:",e,t?"(error)":"");const i=document.getElementById("status-message");i.textContent=e,i.classList.remove("hidden","success-message","error-message"),i.classList.add(t?"error-message":"success-message"),setTimeout(()=>{i.classList.add("hidden")},5e3)}function openDiscordAuthPopup(){debug("Opening Discord OAuth popup");var e=window.screenX+(window.outerWidth-600)/2,t=window.screenY+(window.outerHeight-800)/2,i=`https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${DISCORD_REDIRECT_URI}&response_type=token&scope=identify`;authWindow=window.open(i,"Discord Authentication",`width=600,height=800,left=${e},top=${t},resizable=yes,scrollbars=yes`);const n=setInterval(()=>{try{var e;authWindow.closed?clearInterval(n):authWindow.location.href.includes("access_token=")&&(clearInterval(n),e=new URLSearchParams(authWindow.location.hash.substring(1)).get("access_token"),authWindow.close(),e)&&(debug("Got access token from popup:",e.substring(0,10)+"..."),handleDiscordAuth(e))}catch(e){}},500)}async function handleDiscordAuth(e){debug("Handling Discord auth with token"),hideOAuthPopup();var t=await getUserInfo(e);t?(discordToken=e,discordUserId=t.id,debug("Auth successful:",t.username,discordUserId),debug("Is admin?",discordUserId===ADMIN_DISCORD_ID),pendingAppIdToDelete&&(debug("Processing pending deletion:",pendingAppIdToDelete),e=pendingAppIdToDelete,pendingAppIdToDelete=null,await deleteApplication(e))):showStatusMessage("Discord authentication failed. Please try again.",!0)}async function getUserInfo(e){debug("Getting user info with token:",e.substring(0,10)+"...");try{var t,i,n=await fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+e}});if(n.ok)return debug("User info received:",(i=await n.json()).username,i.id),i;throw t=await n.text(),debug("Discord API error:",n.status,t),new Error("Failed to get user info from Discord: "+n.status)}catch(e){return debug("Error getting Discord user info:",e),console.error("Error getting Discord user info:",e),null}}async function deleteApplication(n){debug("Attempting to delete application:",n),debug("Current user ID:",discordUserId),debug("Admin ID:",ADMIN_DISCORD_ID);try{if(discordUserId!==ADMIN_DISCORD_ID)return debug("Delete failed: Not admin"),showStatusMessage("Negalite to padaryti. Jūs neturite administratoriaus teisių.",!0),!1;debug("User is admin, proceeding with deletion");var a=API_BASE_URL+"/Anketos?ID=eq."+encodeURIComponent(n.trim()),o=(debug("Fetching application details:",a),await fetch(a,{headers:{apikey:API_KEY,Authorization:"Bearer "+API_KEY}}));if(!o.ok)throw new Error("Failed to fetch application details. Status: "+o.status);var s=await o.json();if(debug("Found applications:",s.length),0===s.length)throw new Error("Application not found");var d=document.querySelector(`.application-item[data-id="${n}"]`);if(!d)throw new Error("Could not locate the clicked application in the DOM");const c={nick:d.querySelector(".user-id")?.textContent.trim().replace("@",""),status:d.querySelector(".status-tag")?.textContent.trim(),date:d.querySelector(".application-date")?.textContent.trim()};d.querySelectorAll(".field-name").forEach(e=>{var t=e.textContent.trim(),e=e.nextElementSibling;t.includes("Amžius")&&e?c.metai=e.textContent.trim():t.includes("pc check")&&e?c.pccheck=e.textContent.trim():t.includes("įspėjimą")&&e?c.isp=e.textContent.trim():t.includes("Atmetimo priežastis")&&e&&(c.priezastis=e.textContent.trim())}),d.querySelectorAll(".rating-label").forEach(e=>{var t=e.textContent.trim(),e=e.nextElementSibling;t.includes("Pašaudymo lygis")&&e?c.pl=e.textContent.trim():t.includes("Komunikavimo lygis")&&e&&(c.kl=e.textContent.trim())}),debug("Clicked element data:",c);let t=null,i=0;for(const l of s){let e=0;l.NICK===c.nick&&(e+=10),l.STATUS===c.status&&(e+=5),formatDate(l.DATA)===c.date&&(e+=8),l.METAI&&c.metai&&l.METAI.toString()===c.metai&&(e+=3),l.PL&&c.pl&&l.PL.toString()===c.pl&&(e+=3),l.KL&&c.kl&&l.KL.toString()===c.kl&&(e+=3),l.PCCHECK===c.pccheck&&(e+=3),l.ISP===c.isp&&(e+=3),l.PRIEŽASTIS===c.priezastis&&(e+=3),debug(`App match score (${l.NICK}, ${formatDate(l.DATA)}): `+e),e>i&&(i=e,t=l)}if(!t)throw new Error("Could not identify the specific application to delete");debug("Found target application for deletion:",t);let e=API_BASE_URL+"/Anketos?ID=eq."+encodeURIComponent(n.trim());t.DATA&&(e+="&DATA=eq."+encodeURIComponent(t.DATA)),t.NICK&&(e+="&NICK=eq."+encodeURIComponent(t.NICK)),t.STATUS&&(e+="&STATUS=eq."+encodeURIComponent(t.STATUS)),null!==t.METAI&&void 0!==t.METAI&&(e+="&METAI=eq."+encodeURIComponent(t.METAI)),null!==t.PL&&void 0!==t.PL&&(e+="&PL=eq."+encodeURIComponent(t.PL)),null!==t.KL&&void 0!==t.KL&&(e+="&KL=eq."+encodeURIComponent(t.KL)),t.PCCHECK&&(e+="&PCCHECK=eq."+encodeURIComponent(t.PCCHECK)),t.ISP&&(e+="&ISP=eq."+encodeURIComponent(t.ISP)),t.PRIEŽASTIS&&(e+="&PRIEŽASTIS=eq."+encodeURIComponent(t.PRIEŽASTIS)),debug("Delete URL with all filters:",e);var r=await fetch(e,{method:"DELETE",headers:{apikey:API_KEY,Authorization:"Bearer "+API_KEY,"Content-Type":"application/json"}});debug("Delete response status:",r.status);try{debug("Delete response text:",await r.text())}catch(e){debug("Could not get response text:",e)}if(r.ok)return showStatusMessage("Aplikacija sėkmingai ištrinta!"),debug("Delete successful"),d.remove(),!0;throw new Error("Failed to delete. Status: "+r.status)}catch(e){return debug("Error deleting application:",e),console.error("Error deleting application:",e),showStatusMessage("Klaida trinant aplikaciją: "+e.message,!0),!1}}async function removeApplication(e){if(debug("Remove application clicked:",e),pendingAppIdToDelete=e,!discordToken||!discordUserId)return debug("No Discord token/user ID, showing auth popup"),showOAuthPopup(),!1;debug("Has Discord auth, confirming deletion"),confirm("Ar tikrai norite ištrinti šią aplikaciją?")?await deleteApplication(e):(debug("User cancelled deletion"),pendingAppIdToDelete=null)}function createDiscordEmbeds(e){if(debug("Creating embeds for",e?e.length:0,"applications"),!e||0===e.length)return'<div class="error">No applications found.</div>';let o="";return e.forEach(e=>{var t=getStatusClass(e.STATUS),i=formatDate(e.DATA),n=e.STATUS&&(e.STATUS.toLowerCase().includes("atmesta")||e.STATUS.toLowerCase().includes("atmestas")||e.STATUS.toLowerCase().includes("rejected")),a=`<button class="remove-btn" data-id="${e.ID||e.id}">Pašalinti</button>`;o+=`
            <div class="application-item" data-id="${e.ID||e.id}">
                <div class="application-header">
                    <div class="application-id">
                        <img src="https://cdn.discordapp.com/icons/1325850250027597845/a_390be3fdaab65e28c28d150ca21d93bb.gif?size=1024" alt="MM" class="header-logo">
                        <div class="user-info">
                            <span class="username">Anketos</span>
                            <span class="user-id">@${e.NICK||"N/A"}</span>
                        </div>
                        <span class="status-tag ${t}">${e.STATUS||"Peržiūrima"}</span>
                    </div>
                    <div class="application-actions">
                        <div class="application-date">${i}</div>
                        ${a}
                    </div>
                </div>
                
                <div class="application-field">
                    <div class="field-name">Amžius</div>
                    <div class="field-value">${e.METAI||"N/A"}</div>
                </div>

                <div class="application-field">
                    <div class="field-name">Dėl ko nori i Ganga</div>
                    <div class="field-value">${e.REASON||"N/A"}</div>
                </div>
                
                ${n?`
                <div class="application-field">
                    <div class="field-name">Atmetimo priežastis</div>
                    <div class="field-value rejection-reason">${e.PRIEŽASTIS||"Nepateikta"}</div>
                </div>
                `:""}
                
                <div class="application-field">
                    <div class="field-name">Ar sutiktumėte pasidaryti pc check?</div>
                    <div class="field-value">${e.PCCHECK||"Taip"}</div>
                </div>
                
                <div class="application-field">
                    <div class="field-name">Ar išpirkumėte įspėjimą jei jis būtų dėl jūsų kaltės?</div>
                    <div class="field-value">${e.ISP||"Taip"}</div>
                </div>
                
                <div class="rating-row">
                    <div class="rating-item">
                        <div class="rating-label">Pašaudymo lygis</div>
                        <div class="rating-value">${e.PL||"0"}</div>
                    </div>
                    <div class="rating-item">
                        <div class="rating-label">Komunikavimo lygis</div>
                        <div class="rating-value">${e.KL||"0"}</div>
                    </div>
                </div>
                
                <div class="bottom-info">
                    <img src="https://cdn.discordapp.com/icons/1325850250027597845/a_390be3fdaab65e28c28d150ca21d93bb.gif?size=1024" alt="MM" class="footer-logo">
                    Miela Malonu | Anketos
                </div>
            </div>
        `}),o}function setupRemoveButtons(){debug("Setting up remove button event listeners");var e=document.querySelectorAll(".remove-btn");e.forEach(e=>{var t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();e=this.getAttribute("data-id");debug("Remove button clicked for ID:",e),e&&removeApplication(e)})}),debug("Total remove buttons with listeners:",e.length)}async function fetchApplications(t=null){debug("Fetching applications for user:",t);var i=document.getElementById("content");i.innerHTML='<div class="loading">Loading application data...</div>';try{let e=API_BASE_URL+"/Anketos?select=ID,METAI,PRIEŽASTIS,PL,KL,PCCHECK,ISP,STATUS,DATA,NICK,REASON";t&&(e+="&ID=eq."+encodeURIComponent(t)),debug("Fetch URL:",e);var n=await fetch(e,{headers:{apikey:API_KEY,Authorization:"Bearer "+API_KEY}});if(!n.ok)throw new Error("HTTP error! Status: "+n.status);var a=await n.json();debug("Received",a.length,"applications"),i.innerHTML=createDiscordEmbeds(a),setupRemoveButtons()}catch(e){debug("Error fetching data:",e),console.error("Error fetching data:",e),i.innerHTML=`<div class="error">Failed to load applications: ${e.message}</div>`}}function setupSearchButton(){const t=document.getElementById("searchButton"),i=document.getElementById("userId");t.addEventListener("click",()=>{var e=i.value.trim();e&&(window.location.href="anketos.html?user="+e)}),i.addEventListener("keypress",e=>{"Enter"===e.key&&t.click()})}function setupAuthButtons(){var e=document.getElementById("authenticate-btn"),t=document.getElementById("cancel-auth-btn");e.addEventListener("click",()=>{debug("Auth button clicked, opening Discord OAuth popup"),hideOAuthPopup(),openDiscordAuthPopup()}),t.addEventListener("click",()=>{debug("Cancel auth button clicked"),pendingAppIdToDelete=null,hideOAuthPopup()})}document.addEventListener("click",function(e){e.target&&e.target.classList.contains("remove-btn")&&(e.preventDefault(),e.stopPropagation(),debug("Remove button clicked via delegation for ID:",e=e.target.getAttribute("data-id")),e)&&removeApplication(e)}),window.addEventListener("message",function(e){e.data&&"discord_auth"===e.data.type&&(debug("Received message from auth popup:",e.data),handleDiscordAuth(e.data.token))}),document.addEventListener("DOMContentLoaded",async()=>{debug("DOM loaded"),setupSearchButton(),setupAuthButtons();var e=getQueryParam("user");debug("User ID from URL:",e),e&&(document.getElementById("userId").value=e),await fetchApplications(e)});
