document.addEventListener("DOMContentLoaded",function(){const i={SUPABASE:{URL:"https://supa.mielamalonu.com/api/supabase/",API_KEY:"cbb"},DISCORD:{DISCORD_CLIENT_ID:"1263389179249692693",REDIRECT_URI:window.location.origin+window.location.pathname,ROLE_CHECK_ENDPOINT:"https://mielamalonu-rolecheck1-production.up.railway.app/api/check-role"}},r={loginSection:document.getElementById("login-section"),profileContainer:document.getElementById("profile-container"),formSection:document.getElementById("form-section"),noRoleMessage:document.getElementById("no-role-message"),discordLogin:document.getElementById("discord-login"),logoutButton:document.getElementById("logout-button"),submitButton:document.getElementById("submit-button"),statusMessage:document.getElementById("status-message"),discordAvatar:document.getElementById("discord-avatar"),discordUsername:document.getElementById("discord-username"),systemClosedMessage:document.getElementById("system-closed-message")};let d=null,l=!1,c=!0;async function m(e,t){try{var o=await fetch(i.DISCORD.ROLE_CHECK_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,token:t})});return!!o.ok&&(await o.json()).hasRole}catch(e){return console.error("Role check failed:",e),!1}}function u(){r.loginSection.classList.add("hidden"),r.profileContainer.style.display="flex",r.discordUsername.textContent=d.global_name||d.username,r.discordAvatar.src=d.avatar?`https://cdn.discordapp.com/avatars/${d.id}/${d.avatar}.png`:`https://cdn.discordapp.com/embed/avatars/${d.discriminator%5}.png`,l&&c?(r.formSection.classList.remove("hidden"),r.noRoleMessage.style.display="none",r.systemClosedMessage.style.display="none"):l?c||(r.formSection.classList.add("hidden"),r.noRoleMessage.style.display="none",r.systemClosedMessage.style.display="block"):(r.formSection.classList.add("hidden"),r.noRoleMessage.style.display="block",r.systemClosedMessage.style.display="none")}function y(){localStorage.removeItem("discord_token"),localStorage.removeItem("discord_user"),d=null,l=!1,r.loginSection.classList.remove("hidden"),r.profileContainer.style.display="none",r.formSection.classList.add("hidden"),r.noRoleMessage.style.display="none"}async function g(e){e=await fetch("https://discord.com/api/users/@me",{headers:{Authorization:"Bearer "+e}});return e.ok?e.json():null}function p(e,t){r.statusMessage.textContent=e,r.statusMessage.className=t,r.statusMessage.classList.remove("hidden"),setTimeout(()=>r.statusMessage.classList.add("hidden"),5e3)}r.discordLogin.addEventListener("click",()=>{window.location.href=`https://discord.com/api/oauth2/authorize?client_id=${i.DISCORD.DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(i.DISCORD.REDIRECT_URI)}&response_type=token&scope=identify`}),r.logoutButton.addEventListener("click",y),r.submitButton.addEventListener("click",async()=>{if(l)if(c){if((e=document.getElementById("id-number")).value.trim()?!(e.style.borderColor=""):!(e.style.borderColor="rgba(237, 66, 69, 0.6)")){var s,e=document.getElementById("id-number").value.trim();r.submitButton.disabled=!0,r.submitButton.classList.add("loading"),r.loadingSpinner=document.getElementById("loading-spinner"),r.loadingSpinner.classList.remove("hidden");try{s=e,await new Promise((t,o)=>{fetch(i.SUPABASE.URL+"/Event?id=eq.1",{method:"GET",headers:{"Content-Type":"application/json",apikey:i.SUPABASE.API_KEY}}).then(e=>{if(e.ok)return e.json();throw new Error("Nepavyko gauti duomenų")}).then(e=>{if(!e||0===e.length)throw new Error("Duomenys nerasti");let t=e[0].IDs||[];if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t=[]}return(t=Array.isArray(t)?t:[]).push(s),fetch(i.SUPABASE.URL+"/Event?id=eq.1",{method:"PATCH",headers:{"Content-Type":"application/json",apikey:i.SUPABASE.API_KEY,Prefer:"return=minimal"},body:JSON.stringify({IDs:t})})}).then(e=>{e.ok?t():o(new Error("Nepavyko atnaujinti ID"))}).catch(e=>{console.error("Error submitting ID:",e),o(new Error("Įvyko serverio klaida"))})}),p("ID pateiktas sėkmingai ✅","success"),document.getElementById("id-number").value=""}catch(e){p(e.message||"Įvyko klaida","error")}finally{r.submitButton.disabled=!1,r.submitButton.classList.remove("loading"),r.loadingSpinner.classList.add("hidden")}}}else p("Sistema šiuo metu uždaryta","error");else p("Neturite reikiamos rolės","error")}),async function(){try{var e=await fetch(i.SUPABASE.URL+"/ID?id=eq.1",{method:"GET",headers:{"Content-Type":"application/json",apikey:i.SUPABASE.API_KEY}});if(!e.ok)throw new Error("Nepavyko patikrinti sistemos statuso");var t=await e.json();t&&0<t.length&&((c="uždaryta"!==t[0].statusas)?r.systemClosedMessage.style.display="none":(r.systemClosedMessage.style.display="block",r.formSection.classList.add("hidden")))}catch(e){console.error("Error checking system status:",e),c=!1,r.systemClosedMessage.style.display="block",r.formSection.classList.add("hidden")}if(await 0,s=new URLSearchParams(window.location.hash.substring(1)).get("access_token")){window.history.replaceState({},document.title,window.location.pathname);try{var o=await g(s);o&&(d=o,localStorage.setItem("discord_token",s),localStorage.setItem("discord_user",JSON.stringify(o)),l=await m(o.id,s),u())}catch(e){console.error("Login error:",e),p("Prisijungimo klaida","error")}}else{var s=localStorage.getItem("discord_token"),n=localStorage.getItem("discord_user");if(s&&n)try{var a=await g(s);a&&(d=a,l=await m(a.id,s),u())}catch{y()}}}()});
